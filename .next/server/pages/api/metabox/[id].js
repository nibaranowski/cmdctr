"use strict";(()=>{var t={};t.id=276,t.ids=[276],t.modules={1185:t=>{t.exports=require("mongoose")},145:t=>{t.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9926:t=>{t.exports=import("zod")},6249:(t,e)=>{Object.defineProperty(e,"l",{enumerable:!0,get:function(){return function t(e,a){return a in e?e[a]:"then"in e&&"function"==typeof e.then?e.then(e=>t(e,a)):"function"==typeof e&&"default"===a?e:void 0}}})},3216:(t,e,a)=>{a.a(t,async(t,i)=>{try{a.r(e),a.d(e,{config:()=>h,default:()=>c,routeModule:()=>u});var n=a(1802),s=a(7153),r=a(6249),o=a(8093),d=t([o]);o=(d.then?(await d)():d)[0];let c=(0,r.l)(o,"default"),h=(0,r.l)(o,"config"),u=new n.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/metabox/[id]",pathname:"/api/metabox/[id]",bundlePath:"",filename:""},userland:o});i()}catch(t){i(t)}})},1053:(t,e,a)=>{a.d(e,{Z:()=>o});var i=a(1185),n=a.n(i);let s=process.env.MONGODB_URI;if(!s)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let r=global.mongoose;r||(r=global.mongoose={conn:null,promise:null});let o=async function(){if(r.conn)return r.conn;r.promise||(r.promise=n().connect(s,{bufferCommands:!1}).then(t=>t));try{r.conn=await r.promise}catch(t){throw r.promise=null,t}return r.conn}},1151:(t,e,a)=>{a.a(t,async(t,i)=>{try{a.d(e,{HR:()=>c,jU:()=>d});var n=a(9926),s=t([n]);let r=(n=(s.then?(await s)():s)[0]).z.object({id:n.z.string().min(1),name:n.z.string().min(1),order:n.z.number().int().nonnegative(),description:n.z.string().optional(),agent_id:n.z.string().optional(),metabox_id:n.z.string().min(1),created_at:n.z.string().datetime(),updated_at:n.z.string().datetime()}),o=n.z.object({id:n.z.string().min(1),name:n.z.string().min(1),description:n.z.string(),phases:n.z.array(r),created_at:n.z.string().datetime(),updated_at:n.z.string().datetime(),version:n.z.number().int().positive()}),d=n.z.object({id:n.z.string().min(1),name:n.z.string().min(1),description:n.z.string().optional(),company_id:n.z.string().min(1),owner_id:n.z.string().optional(),shared_with:n.z.array(n.z.string()),phases:n.z.array(r),templates:n.z.array(o),version:n.z.number().int().positive(),created_at:n.z.string().datetime(),updated_at:n.z.string().datetime(),metadata:n.z.record(n.z.unknown()).optional()});class c{constructor(t){this.id=t.id||`metabox_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,this.name=t.name,this.description=t.description,this.company_id=t.company_id,this.owner_id=t.owner_id,this.shared_with=t.shared_with||[],this.phases=(t.phases||[]).map(t=>new u(t)),this.templates=(t.templates||[]).map(t=>new h(t)),this.version=t.version||1,this.created_at=t.created_at||new Date().toISOString(),this.updated_at=t.updated_at||new Date().toISOString(),this.metadata=t.metadata}update(t){void 0!==t.name&&(this.name=t.name),void 0!==t.description&&(this.description=t.description),void 0!==t.shared_with&&(this.shared_with=t.shared_with),void 0!==t.metadata&&(this.metadata=t.metadata),this.version++,this.updated_at=new Date().toISOString()}addPhase(t){let e=new u({...t,metabox_id:this.id});this.phases.push(e),this.phases.sort((t,e)=>t.order-e.order),this.version++,this.updated_at=new Date().toISOString()}removePhase(t){let e=this.phases.length;return this.phases=this.phases.filter(e=>e.id!==t),this.phases.length!==e&&(this.version++,this.updated_at=new Date().toISOString(),!0)}createTemplate(t,e){let a=new h({name:t,description:e,phases:this.phases.map(t=>({id:t.id,name:t.name,order:t.order,description:t.description,agent_id:t.agent_id,metabox_id:t.metabox_id,created_at:t.created_at,updated_at:t.updated_at}))});return this.templates.push(a),this.version++,this.updated_at=new Date().toISOString(),a}applyTemplate(t){this.phases=t.phases.map(t=>new u({...t,id:`phase_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,metabox_id:this.id,created_at:new Date().toISOString(),updated_at:new Date().toISOString()})),this.version++,this.updated_at=new Date().toISOString()}canAccess(t){return this.owner_id===t||this.shared_with.includes(t)}canEdit(t){return this.owner_id===t}detectConflict(t){return t.version<this.version?{hasConflict:!0,message:`Version conflict: local version ${this.version}, incoming version ${t.version}`}:{hasConflict:!1}}}class h{constructor(t){this.id=t.id||`template_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,this.name=t.name,this.description=t.description,this.phases=(t.phases||[]).map(t=>new u(t)),this.created_at=t.created_at||new Date().toISOString(),this.updated_at=t.updated_at||new Date().toISOString(),this.version=t.version||1}update(t){void 0!==t.name&&(this.name=t.name),void 0!==t.description&&(this.description=t.description),void 0!==t.phases&&(this.phases=t.phases.map(t=>new u(t))),this.version++,this.updated_at=new Date().toISOString()}}class u{constructor(t){this.id=t.id||`phase_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,this.name=t.name,this.order=t.order,this.description=t.description,this.agent_id=t.agent_id,this.metabox_id=t.metabox_id,this.created_at=t.created_at||new Date().toISOString(),this.updated_at=t.updated_at||new Date().toISOString()}update(t){void 0!==t.name&&(this.name=t.name),void 0!==t.order&&(this.order=t.order),void 0!==t.description&&(this.description=t.description),void 0!==t.agent_id&&(this.agent_id=t.agent_id),this.updated_at=new Date().toISOString()}}i()}catch(t){i(t)}})},8093:(t,e,a)=>{a.a(t,async(t,i)=>{try{a.r(e),a.d(e,{default:()=>c});var n=a(1185),s=a.n(n),r=a(1053),o=a(1151),d=t([o]);async function c(t,e){let{id:a}=t.query;return a&&"string"==typeof a?"GET"===t.method?h(t,e,a):"PUT"===t.method?u(t,e,a):"DELETE"===t.method?p(t,e,a):void(e.setHeader("Allow",["GET","PUT","DELETE"]),e.status(405).json({error:"Method not allowed"})):e.status(400).json({error:"Meta box ID is required"})}async function h(t,e,a){try{let{user_id:i}=t.query;await (0,r.Z)();let n=s().model("MetaBox",new(s()).Schema({})).collection,d=await n.findOne({id:a});if(!d)return e.status(404).json({error:"Meta box not found"});let c=new o.HR(d);if(i&&"string"==typeof i&&!c.canAccess(i))return e.status(403).json({error:"Access denied"});e.status(200).json({success:!0,data:c})}catch(t){console.error("Error fetching meta box:",t),e.status(500).json({error:"Internal server error"})}}async function u(t,e,a){try{let{user_id:i}=t.body;if(!i)return e.status(400).json({error:"user_id is required"});await (0,r.Z)();let n=s().model("MetaBox",new(s()).Schema({})).collection,d=await n.findOne({id:a});if(!d)return e.status(404).json({error:"Meta box not found"});let c=new o.HR(d);if(!c.canEdit(i))return e.status(403).json({error:"Edit access denied"});let h={...d,...t.body},u=o.jU.safeParse(h);if(!u.success)return e.status(400).json({error:"Invalid meta box data",details:u.error.errors});let p=c.detectConflict({version:t.body.version||0,changes:t.body});if(p.hasConflict)return e.status(409).json({error:"Version conflict",message:p.message});let m=new o.HR(h);m.version=c.version+1,m.updated_at=new Date().toISOString(),(await n.updateOne({id:a},{$set:m})).modifiedCount>0?e.status(200).json({success:!0,data:m,message:"Meta box updated successfully"}):e.status(500).json({error:"Failed to update meta box"})}catch(t){console.error("Error updating meta box:",t),e.status(500).json({error:"Internal server error"})}}async function p(t,e,a){try{let{user_id:i}=t.body;if(!i)return e.status(400).json({error:"user_id is required"});await (0,r.Z)();let n=s().model("MetaBox",new(s()).Schema({})).collection,d=await n.findOne({id:a});if(!d)return e.status(404).json({error:"Meta box not found"});if(!new o.HR(d).canEdit(i))return e.status(403).json({error:"Delete access denied"});(await n.deleteOne({id:a})).deletedCount>0?e.status(200).json({success:!0,message:"Meta box deleted successfully"}):e.status(500).json({error:"Failed to delete meta box"})}catch(t){console.error("Error deleting meta box:",t),e.status(500).json({error:"Internal server error"})}}o=(d.then?(await d)():d)[0],i()}catch(t){i(t)}})},7153:(t,e)=>{var a;Object.defineProperty(e,"x",{enumerable:!0,get:function(){return a}}),function(t){t.PAGES="PAGES",t.PAGES_API="PAGES_API",t.APP_PAGE="APP_PAGE",t.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(t,e,a)=>{t.exports=a(145)}};var e=require("../../../webpack-api-runtime.js");e.C(t);var a=e(e.s=3216);module.exports=a})();