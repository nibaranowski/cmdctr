"use strict";(()=>{var e={};e.id=918,e.ids=[918],e.modules={1185:e=>{e.exports=require("mongoose")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9926:e=>{e.exports=import("zod")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},2389:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>h,default:()=>c,routeModule:()=>u});var i=a(1802),n=a(7153),s=a(6249),o=a(5277),d=e([o]);o=(d.then?(await d)():d)[0];let c=(0,s.l)(o,"default"),h=(0,s.l)(o,"config"),u=new i.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/metabox",pathname:"/api/metabox",bundlePath:"",filename:""},userland:o});r()}catch(e){r(e)}})},1053:(e,t,a)=>{a.d(t,{Z:()=>o});var r=a(1185),i=a.n(r);let n=process.env.MONGODB_URI;if(!n)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let s=global.mongoose;s||(s=global.mongoose={conn:null,promise:null});let o=async function(){if(s.conn)return s.conn;s.promise||(s.promise=i().connect(n,{bufferCommands:!1}).then(e=>e));try{s.conn=await s.promise}catch(e){throw s.promise=null,e}return s.conn}},1151:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.d(t,{HR:()=>c,jU:()=>d});var i=a(9926),n=e([i]);let s=(i=(n.then?(await n)():n)[0]).z.object({id:i.z.string().min(1),name:i.z.string().min(1),order:i.z.number().int().nonnegative(),description:i.z.string().optional(),agent_id:i.z.string().optional(),metabox_id:i.z.string().min(1),created_at:i.z.string().datetime(),updated_at:i.z.string().datetime()}),o=i.z.object({id:i.z.string().min(1),name:i.z.string().min(1),description:i.z.string(),phases:i.z.array(s),created_at:i.z.string().datetime(),updated_at:i.z.string().datetime(),version:i.z.number().int().positive()}),d=i.z.object({id:i.z.string().min(1),name:i.z.string().min(1),description:i.z.string().optional(),company_id:i.z.string().min(1),owner_id:i.z.string().optional(),shared_with:i.z.array(i.z.string()),phases:i.z.array(s),templates:i.z.array(o),version:i.z.number().int().positive(),created_at:i.z.string().datetime(),updated_at:i.z.string().datetime(),metadata:i.z.record(i.z.unknown()).optional()});class c{constructor(e){this.id=e.id||`metabox_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,this.name=e.name,this.description=e.description,this.company_id=e.company_id,this.owner_id=e.owner_id,this.shared_with=e.shared_with||[],this.phases=(e.phases||[]).map(e=>new u(e)),this.templates=(e.templates||[]).map(e=>new h(e)),this.version=e.version||1,this.created_at=e.created_at||new Date().toISOString(),this.updated_at=e.updated_at||new Date().toISOString(),this.metadata=e.metadata}update(e){void 0!==e.name&&(this.name=e.name),void 0!==e.description&&(this.description=e.description),void 0!==e.shared_with&&(this.shared_with=e.shared_with),void 0!==e.metadata&&(this.metadata=e.metadata),this.version++,this.updated_at=new Date().toISOString()}addPhase(e){let t=new u({...e,metabox_id:this.id});this.phases.push(t),this.phases.sort((e,t)=>e.order-t.order),this.version++,this.updated_at=new Date().toISOString()}removePhase(e){let t=this.phases.length;return this.phases=this.phases.filter(t=>t.id!==e),this.phases.length!==t&&(this.version++,this.updated_at=new Date().toISOString(),!0)}createTemplate(e,t){let a=new h({name:e,description:t,phases:this.phases.map(e=>({id:e.id,name:e.name,order:e.order,description:e.description,agent_id:e.agent_id,metabox_id:e.metabox_id,created_at:e.created_at,updated_at:e.updated_at}))});return this.templates.push(a),this.version++,this.updated_at=new Date().toISOString(),a}applyTemplate(e){this.phases=e.phases.map(e=>new u({...e,id:`phase_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,metabox_id:this.id,created_at:new Date().toISOString(),updated_at:new Date().toISOString()})),this.version++,this.updated_at=new Date().toISOString()}canAccess(e){return this.owner_id===e||this.shared_with.includes(e)}canEdit(e){return this.owner_id===e}detectConflict(e){return e.version<this.version?{hasConflict:!0,message:`Version conflict: local version ${this.version}, incoming version ${e.version}`}:{hasConflict:!1}}}class h{constructor(e){this.id=e.id||`template_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,this.name=e.name,this.description=e.description,this.phases=(e.phases||[]).map(e=>new u(e)),this.created_at=e.created_at||new Date().toISOString(),this.updated_at=e.updated_at||new Date().toISOString(),this.version=e.version||1}update(e){void 0!==e.name&&(this.name=e.name),void 0!==e.description&&(this.description=e.description),void 0!==e.phases&&(this.phases=e.phases.map(e=>new u(e))),this.version++,this.updated_at=new Date().toISOString()}}class u{constructor(e){this.id=e.id||`phase_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,this.name=e.name,this.order=e.order,this.description=e.description,this.agent_id=e.agent_id,this.metabox_id=e.metabox_id,this.created_at=e.created_at||new Date().toISOString(),this.updated_at=e.updated_at||new Date().toISOString()}update(e){void 0!==e.name&&(this.name=e.name),void 0!==e.order&&(this.order=e.order),void 0!==e.description&&(this.description=e.description),void 0!==e.agent_id&&(this.agent_id=e.agent_id),this.updated_at=new Date().toISOString()}}r()}catch(e){r(e)}})},5277:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{default:()=>c});var i=a(1185),n=a.n(i),s=a(1053),o=a(1151),d=e([o]);async function c(e,t){return"GET"===e.method?h(e,t):"POST"===e.method?u(e,t):"PUT"===e.method?p(e,t):"DELETE"===e.method?m(e,t):void(t.setHeader("Allow",["GET","POST","PUT","DELETE"]),t.status(405).json({error:"Method not allowed"}))}async function h(e,t){try{let{company_id:a,user_id:r}=e.query;if(!a||"string"!=typeof a)return t.status(400).json({error:"company_id is required"});await (0,s.Z)();let i=n().model("MetaBox",new(n()).Schema({})).collection,d={company_id:a};r&&"string"==typeof r&&(d.$or=[{owner_id:r},{shared_with:r}]);let c=(await i.find(d).toArray()).map(e=>new o.HR(e));t.status(200).json({success:!0,data:c,count:c.length})}catch(e){console.error("Error fetching meta boxes:",e),t.status(500).json({error:"Internal server error"})}}async function u(e,t){try{let{company_id:a,user_id:r}=e.body;if(!a||!r)return t.status(400).json({error:"company_id and user_id are required"});let i=o.jU.safeParse(e.body);if(!i.success)return t.status(400).json({error:"Invalid meta box data",details:i.error.errors});await (0,s.Z)();let d=n().model("MetaBox",new(n()).Schema({})).collection,c=new o.HR({...e.body,owner_id:r});(await d.insertOne(c)).acknowledged?t.status(201).json({success:!0,data:c,message:"Meta box created successfully"}):t.status(500).json({error:"Failed to create meta box"})}catch(e){console.error("Error creating meta box:",e),t.status(500).json({error:"Internal server error"})}}async function p(e,t){try{let{id:a,user_id:r,...i}=e.body;if(!a||!r)return t.status(400).json({error:"id and user_id are required"});await (0,s.Z)();let d=n().model("MetaBox",new(n()).Schema({})).collection,c=await d.findOne({id:a});if(!c)return t.status(404).json({error:"Meta box not found"});if(c.owner_id!==r)return t.status(403).json({error:"Permission denied"});let h=o.jU.partial().safeParse(i);if(!h.success)return t.status(400).json({error:"Invalid update data",details:h.error.errors});if((await d.updateOne({id:a},{$set:{...i,updated_at:new Date().toISOString(),version:(c.version||1)+1}})).modifiedCount>0){let e=await d.findOne({id:a});e&&e.name&&e.company_id?t.status(200).json({success:!0,data:new o.HR(e),message:"Meta box updated successfully"}):t.status(500).json({error:"Failed to fetch updated meta box"})}else t.status(500).json({error:"Failed to update meta box"})}catch(e){console.error("Error updating meta box:",e),t.status(500).json({error:"Internal server error"})}}async function m(e,t){try{let{id:a,user_id:r}=e.body;if(!a||!r)return t.status(400).json({error:"id and user_id are required"});await (0,s.Z)();let i=n().model("MetaBox",new(n()).Schema({})).collection,o=await i.findOne({id:a});if(!o)return t.status(404).json({error:"Meta box not found"});if(o.owner_id!==r)return t.status(403).json({error:"Permission denied"});(await i.deleteOne({id:a})).deletedCount>0?t.status(200).json({success:!0,message:"Meta box deleted successfully"}):t.status(500).json({error:"Failed to delete meta box"})}catch(e){console.error("Error deleting meta box:",e),t.status(500).json({error:"Internal server error"})}}o=(d.then?(await d)():d)[0],r()}catch(e){r(e)}})},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var a=t(t.s=2389);module.exports=a})();