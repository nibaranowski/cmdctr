"use strict";(()=>{var e={};e.id=477,e.ids=[477],e.modules={1185:e=>{e.exports=require("mongoose")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9926:e=>{e.exports=import("zod")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,i){return i in t?t[i]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,i)):"function"==typeof t&&"default"===i?t:void 0}}})},6025:(e,t,i)=>{i.a(e,async(e,a)=>{try{i.r(t),i.d(t,{config:()=>c,default:()=>u,routeModule:()=>l});var s=i(1802),r=i(7153),n=i(6249),o=i(7702),d=e([o]);o=(d.then?(await d)():d)[0];let u=(0,n.l)(o,"default"),c=(0,n.l)(o,"config"),l=new s.PagesAPIRouteModule({definition:{kind:r.x.PAGES_API,page:"/api/audit-logs",pathname:"/api/audit-logs",bundlePath:"",filename:""},userland:o});a()}catch(e){a(e)}})},8258:(e,t,i)=>{i.a(e,async(e,a)=>{try{i.d(t,{Ac:()=>c,aW:()=>l,mI:()=>u,vp:()=>d});var s=i(6413),r=i(1053),n=e([s]);async function o(e,t){try{await (0,r.Z)();let i=e.ip_address||(t?t.headers["x-forwarded-for"]?.split(",")[0]||t.headers["x-real-ip"]||t.socket?.remoteAddress||t.connection?.remoteAddress:void 0),a=e.user_agent||(t?t.headers["user-agent"]:void 0);return await s.o.create({...e,ip_address:i,user_agent:a,timestamp:new Date})}catch(e){throw console.error("Failed to log audit event:",e),e}}async function d(e){try{await (0,r.Z)();let t={};e.event_type&&(t.event_type=e.event_type),e.severity&&(t.severity=e.severity),e.user_id&&(t.user_id=e.user_id),e.user_email&&(t.user_email=e.user_email),e.ip_address&&(t.ip_address=e.ip_address),e.session_id&&(t.session_id=e.session_id),e.company_id&&(t.company_id=e.company_id),(e.start_date||e.end_date)&&(t.timestamp={},e.start_date&&(t.timestamp.$gte=e.start_date),e.end_date&&(t.timestamp.$lte=e.end_date));let i=e.limit||50,a=e.offset||0,[n,o]=await Promise.all([s.o.find(t).sort({timestamp:-1}).skip(a).limit(i+1).exec(),s.o.countDocuments(t).exec()]),d=n.length>i;return{logs:d?n.slice(0,i):n,total:o,hasMore:d}}catch(e){throw console.error("Failed to query audit logs:",e),e}}async function u(e,t,i,a,s){let r=e.includes("failed")||e.includes("expired")?"medium":"low";return o({event_type:e,severity:r,user_email:t,user_id:i,details:a},s)}async function c(e,t,i,a,s){return o({event_type:e,severity:"low",user_id:t,user_email:i,details:a},s)}async function l(e,t=30){try{await (0,r.Z)();let i=new Date;i.setDate(i.getDate()-t);let a={timestamp:{$gte:i}};e&&(a.company_id=e);let[n,o,d,u]=await Promise.all([s.o.countDocuments(a),s.o.aggregate([{$match:a},{$group:{_id:"$event_type",count:{$sum:1}}},{$sort:{count:-1}}]),s.o.aggregate([{$match:a},{$group:{_id:"$severity",count:{$sum:1}}},{$sort:{count:-1}}]),s.o.countDocuments({...a,timestamp:{$gte:new Date(Date.now()-864e5)}})]);return{total_events:n,events_by_type:o.reduce((e,t)=>(e[t._id]=t.count,e),{}),events_by_severity:d.reduce((e,t)=>(e[t._id]=t.count,e),{}),recent_activity:u}}catch(e){throw console.error("Failed to get audit stats:",e),e}}s=(n.then?(await n)():n)[0],a()}catch(e){a(e)}})},1053:(e,t,i)=>{i.d(t,{Z:()=>o});var a=i(1185),s=i.n(a);let r=process.env.MONGODB_URI;if(!r)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let n=global.mongoose;n||(n=global.mongoose={conn:null,promise:null});let o=async function(){if(n.conn)return n.conn;n.promise||(n.promise=s().connect(r,{bufferCommands:!1}).then(e=>e));try{n.conn=await n.promise}catch(e){throw n.promise=null,e}return n.conn}},6413:(e,t,i)=>{i.a(e,async(e,a)=>{try{i.d(t,{o:()=>u});var s=i(1185),r=i.n(s),n=i(9926),o=e([n]);n=(o.then?(await o)():o)[0];let d=new s.Schema({event_type:{type:String,required:!0,enum:["auth.login","auth.logout","auth.login_failed","auth.password_reset","auth.magic_link_sent","auth.magic_link_used","auth.magic_link_expired","auth.session_created","auth.session_revoked","auth.invite_created","auth.invite_accepted","auth.invite_expired","auth.role_changed","auth.permissions_updated","user.created","user.updated","user.deleted","user.deactivated","user.reactivated","system.error","system.warning","system.info","security.suspicious_activity","security.rate_limit_exceeded","security.ip_blocked","security.account_locked"]},severity:{type:String,required:!0,enum:["low","medium","high","critical"],default:"low"},user_id:{type:String,index:!0},user_email:{type:String,index:!0},ip_address:{type:String,index:!0},user_agent:{type:String},session_id:{type:String,index:!0},resource_type:{type:String},resource_id:{type:String},action:{type:String},details:{type:s.Schema.Types.Mixed},metadata:{type:s.Schema.Types.Mixed},timestamp:{type:Date,default:Date.now,index:!0},company_id:{type:String,index:!0}},{timestamps:!0});d.index({event_type:1,timestamp:-1}),d.index({severity:1,timestamp:-1}),d.index({user_id:1,timestamp:-1}),d.index({ip_address:1,timestamp:-1}),d.index({company_id:1,timestamp:-1}),d.index({timestamp:1},{expireAfterSeconds:31536e3});let u=r().models.AuditLog||r().model("AuditLog",d);n.z.object({id:n.z.string(),event_type:n.z.enum(["auth.login","auth.logout","auth.login_failed","auth.password_reset","auth.magic_link_sent","auth.magic_link_used","auth.magic_link_expired","auth.session_created","auth.session_revoked","auth.invite_created","auth.invite_accepted","auth.invite_expired","auth.role_changed","auth.permissions_updated","user.created","user.updated","user.deleted","user.deactivated","user.reactivated","system.error","system.warning","system.info","security.suspicious_activity","security.rate_limit_exceeded","security.ip_blocked","security.account_locked"]),severity:n.z.enum(["low","medium","high","critical"]),user_id:n.z.string().optional(),user_email:n.z.string().email().optional(),ip_address:n.z.string().optional(),user_agent:n.z.string().optional(),session_id:n.z.string().optional(),resource_type:n.z.string().optional(),resource_id:n.z.string().optional(),action:n.z.string().optional(),details:n.z.record(n.z.any()).optional(),metadata:n.z.record(n.z.any()).optional(),timestamp:n.z.string().datetime(),company_id:n.z.string().optional()}),a()}catch(e){a(e)}})},7702:(e,t,i)=>{i.a(e,async(e,a)=>{try{i.r(t),i.d(t,{default:()=>n});var s=i(8258),r=e([s]);async function n(e,t){if("GET"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let{event_type:i,severity:a,user_id:r,user_email:n,ip_address:o,session_id:d,company_id:u,start_date:c,end_date:l,limit:p="50",offset:_="0",stats:m="false"}=e.query;if("true"===m){let i=await (0,s.aW)(u,parseInt(e.query.days)||30);return t.status(200).json({success:!0,stats:i})}let y={};i&&(y.event_type=i),a&&(y.severity=a),r&&(y.user_id=r),n&&(y.user_email=n),o&&(y.ip_address=o),d&&(y.session_id=d),u&&(y.company_id=u),c&&(y.start_date=new Date(c)),l&&(y.end_date=new Date(l)),y.limit=parseInt(p),y.offset=parseInt(_);let g=await (0,s.vp)(y);return t.status(200).json({success:!0,logs:g.logs.map(e=>({id:e._id,event_type:e.event_type,severity:e.severity,user_id:e.user_id,user_email:e.user_email,ip_address:e.ip_address,user_agent:e.user_agent,session_id:e.session_id,resource_type:e.resource_type,resource_id:e.resource_id,action:e.action,details:e.details,metadata:e.metadata,timestamp:e.timestamp,company_id:e.company_id,createdAt:e.createdAt,updatedAt:e.updatedAt})),pagination:{total:g.total,hasMore:g.hasMore,limit:y.limit,offset:y.offset}})}catch(e){return console.error("Audit logs query error:",e),t.status(500).json({error:"Internal server error"})}}s=(r.then?(await r)():r)[0],a()}catch(e){a(e)}})},7153:(e,t)=>{var i;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return i}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(i||(i={}))},1802:(e,t,i)=>{e.exports=i(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var i=t(t.s=6025);module.exports=i})();