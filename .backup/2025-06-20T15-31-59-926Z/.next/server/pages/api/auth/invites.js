"use strict";(()=>{var e={};e.id=787,e.ids=[787],e.modules={1185:e=>{e.exports=require("mongoose")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9926:e=>{e.exports=import("zod")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},2276:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{config:()=>c,default:()=>u,routeModule:()=>d});var i=r(1802),a=r(7153),s=r(6249),o=r(2655),l=e([o]);o=(l.then?(await l)():l)[0];let u=(0,s.l)(o,"default"),c=(0,s.l)(o,"config"),d=new i.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/auth/invites",pathname:"/api/auth/invites",bundlePath:"",filename:""},userland:o});n()}catch(e){n(e)}})},9653:(e,t,r)=>{r.d(t,{C:()=>a});let n=require("nodemailer");var i=r.n(n);async function a({to:e,subject:t,text:r,html:n}){let a=process.env.SMTP_HOST,s=process.env.SMTP_PORT?parseInt(process.env.SMTP_PORT):587,o=process.env.SMTP_USER,l=process.env.SMTP_PASS,u=process.env.EMAIL_FROM||"no-reply@cmdctr.com";if(!a||!o||!l)throw Error("SMTP credentials are not set in environment variables");let c=i().createTransport({host:a,port:s,secure:465===s,auth:{user:o,pass:l}});return await c.sendMail({from:u,to:e,subject:t,text:r,html:n})}},1053:(e,t,r)=>{r.d(t,{Z:()=>o});var n=r(1185),i=r.n(n);let a=process.env.MONGODB_URI;if(!a)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let s=global.mongoose;s||(s=global.mongoose={conn:null,promise:null});let o=async function(){if(s.conn)return s.conn;s.promise||(s.promise=i().connect(a,{bufferCommands:!1}).then(e=>e));try{s.conn=await s.promise}catch(e){throw s.promise=null,e}return s.conn}},5786:(e,t,r)=>{r.d(t,{K:()=>s});var n=r(1185),i=r.n(n);let a=new n.Schema({email:{type:String,required:!0},role:{type:String,required:!0},permissions:{type:[String],default:["read"]},companyId:{type:String},invitedBy:{type:String,required:!0},status:{type:String,enum:["pending","accepted","expired","revoked"],default:"pending"},expiresAt:{type:Date,required:!0},createdAt:{type:Date,default:Date.now}}),s=i().models.Invite||i().model("Invite",a)},971:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.d(t,{n:()=>u});var i=r(1185),a=r.n(i),s=r(9926),o=e([s]);s=(o.then?(await o)():o)[0];let l=new i.Schema({name:{type:String,required:!0},email:{type:String,required:!0,unique:!0},avatar_url:{type:String},roles:{type:[String],enum:["founder","ops_manager","team_member","investor","partner","external_expert"],default:["team_member"]},last_login:{type:Date,default:Date.now},company_id:{type:String},isActive:{type:Boolean,default:!0},permissions:{type:[String],default:["read"]}},{timestamps:!0}),u=a().models.User||a().model("User",l);s.z.object({id:s.z.string(),name:s.z.string(),email:s.z.string().email(),avatar_url:s.z.string().url(),roles:s.z.array(s.z.enum(["founder","ops_manager","team_member","investor","partner","external_expert"])),last_login:s.z.string().datetime(),company_id:s.z.string()}),n()}catch(e){n(e)}})},2655:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{default:()=>u});var i=r(9653),a=r(1053),s=r(5786),o=r(971),l=e([o]);async function u(e,t){switch(await (0,a.Z)(),e.method){case"POST":return c(e,t);case"GET":return d(e,t);default:return t.status(405).json({error:"Method not allowed"})}}async function c(e,t){try{let{email:r,role:n,permissions:a,companyId:l}=e.body;if(!r||!r.includes("@"))return t.status(400).json({error:"Valid email is required"});if(await o.n.findOne({email:r}).exec())return t.status(400).json({error:"User already exists with this email"});let u=await s.K.create({email:r,role:n||"team_member",permissions:a||["read"],companyId:l,invitedBy:e.headers["x-user-id"]||"system",status:"pending",expiresAt:new Date(Date.now()+6048e5),createdAt:new Date}),c=`${process.env.NEXT_PUBLIC_APP_URL}/auth/accept-invite?inviteId=${u._id}`;return await (0,i.C)({to:r,subject:"You are invited to join cmdctr",text:`You have been invited to join cmdctr. Click this link to accept: ${c}
This invite will expire in 7 days.`,html:`<p>You have been invited to join cmdctr.<br>Click <a href="${c}">here</a> to accept. This invite will expire in 7 days.</p>`}),t.status(201).json({success:!0,invite:{id:u._id,email:u.email,role:u.role,permissions:u.permissions,status:u.status,expiresAt:u.expiresAt}})}catch(e){return console.error("Create invite error:",e),t.status(500).json({error:"Internal server error"})}}async function d(e,t){try{let{status:r,companyId:n}=e.query,i={};r&&(i.status=r),n&&(i.companyId=n);let a=await s.K.find(i).exec();return t.status(200).json({success:!0,invites:a.map(e=>({id:e._id,email:e.email,role:e.role,permissions:e.permissions,status:e.status,expiresAt:e.expiresAt,createdAt:e.createdAt}))})}catch(e){return console.error("Get invites error:",e),t.status(500).json({error:"Internal server error"})}}o=(l.then?(await l)():l)[0],n()}catch(e){n(e)}})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=2276);module.exports=r})();