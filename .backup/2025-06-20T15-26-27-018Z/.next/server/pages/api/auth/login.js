"use strict";(()=>{var e={};e.id=908,e.ids=[908],e.modules={1185:e=>{e.exports=require("mongoose")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9926:e=>{e.exports=import("zod")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,i){return i in t?t[i]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,i)):"function"==typeof t&&"default"===i?t:void 0}}})},534:(e,t,i)=>{i.a(e,async(e,r)=>{try{i.r(t),i.d(t,{config:()=>c,default:()=>u,routeModule:()=>l});var n=i(1802),a=i(7153),s=i(6249),o=i(6158),d=e([o]);o=(d.then?(await d)():d)[0];let u=(0,s.l)(o,"default"),c=(0,s.l)(o,"config"),l=new n.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/auth/login",pathname:"/api/auth/login",bundlePath:"",filename:""},userland:o});r()}catch(e){r(e)}})},8258:(e,t,i)=>{i.a(e,async(e,r)=>{try{i.d(t,{Ac:()=>c,aW:()=>l,mI:()=>u,vp:()=>d});var n=i(6413),a=i(1053),s=e([n]);async function o(e,t){try{await (0,a.Z)();let i=e.ip_address||(t?t.headers["x-forwarded-for"]?.split(",")[0]||t.headers["x-real-ip"]||t.socket?.remoteAddress||t.connection?.remoteAddress:void 0),r=e.user_agent||(t?t.headers["user-agent"]:void 0);return await n.o.create({...e,ip_address:i,user_agent:r,timestamp:new Date})}catch(e){throw console.error("Failed to log audit event:",e),e}}async function d(e){try{await (0,a.Z)();let t={};e.event_type&&(t.event_type=e.event_type),e.severity&&(t.severity=e.severity),e.user_id&&(t.user_id=e.user_id),e.user_email&&(t.user_email=e.user_email),e.ip_address&&(t.ip_address=e.ip_address),e.session_id&&(t.session_id=e.session_id),e.company_id&&(t.company_id=e.company_id),(e.start_date||e.end_date)&&(t.timestamp={},e.start_date&&(t.timestamp.$gte=e.start_date),e.end_date&&(t.timestamp.$lte=e.end_date));let i=e.limit||50,r=e.offset||0,[s,o]=await Promise.all([n.o.find(t).sort({timestamp:-1}).skip(r).limit(i+1).exec(),n.o.countDocuments(t).exec()]),d=s.length>i;return{logs:d?s.slice(0,i):s,total:o,hasMore:d}}catch(e){throw console.error("Failed to query audit logs:",e),e}}async function u(e,t,i,r,n){let a=e.includes("failed")||e.includes("expired")?"medium":"low";return o({event_type:e,severity:a,user_email:t,user_id:i,details:r},n)}async function c(e,t,i,r,n){return o({event_type:e,severity:"low",user_id:t,user_email:i,details:r},n)}async function l(e,t=30){try{await (0,a.Z)();let i=new Date;i.setDate(i.getDate()-t);let r={timestamp:{$gte:i}};e&&(r.company_id=e);let[s,o,d,u]=await Promise.all([n.o.countDocuments(r),n.o.aggregate([{$match:r},{$group:{_id:"$event_type",count:{$sum:1}}},{$sort:{count:-1}}]),n.o.aggregate([{$match:r},{$group:{_id:"$severity",count:{$sum:1}}},{$sort:{count:-1}}]),n.o.countDocuments({...r,timestamp:{$gte:new Date(Date.now()-864e5)}})]);return{total_events:s,events_by_type:o.reduce((e,t)=>(e[t._id]=t.count,e),{}),events_by_severity:d.reduce((e,t)=>(e[t._id]=t.count,e),{}),recent_activity:u}}catch(e){throw console.error("Failed to get audit stats:",e),e}}n=(s.then?(await s)():s)[0],r()}catch(e){r(e)}})},9653:(e,t,i)=>{i.d(t,{C:()=>a});let r=require("nodemailer");var n=i.n(r);async function a({to:e,subject:t,text:i,html:r}){let a=process.env.SMTP_HOST,s=process.env.SMTP_PORT?parseInt(process.env.SMTP_PORT):587,o=process.env.SMTP_USER,d=process.env.SMTP_PASS,u=process.env.EMAIL_FROM||"no-reply@cmdctr.com";if(!a||!o||!d)throw Error("SMTP credentials are not set in environment variables");let c=n().createTransport({host:a,port:s,secure:465===s,auth:{user:o,pass:d}});return await c.sendMail({from:u,to:e,subject:t,text:i,html:r})}},1053:(e,t,i)=>{i.d(t,{Z:()=>o});var r=i(1185),n=i.n(r);let a=process.env.MONGODB_URI;if(!a)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let s=global.mongoose;s||(s=global.mongoose={conn:null,promise:null});let o=async function(){if(s.conn)return s.conn;s.promise||(s.promise=n().connect(a,{bufferCommands:!1}).then(e=>e));try{s.conn=await s.promise}catch(e){throw s.promise=null,e}return s.conn}},6413:(e,t,i)=>{i.a(e,async(e,r)=>{try{i.d(t,{o:()=>u});var n=i(1185),a=i.n(n),s=i(9926),o=e([s]);s=(o.then?(await o)():o)[0];let d=new n.Schema({event_type:{type:String,required:!0,enum:["auth.login","auth.logout","auth.login_failed","auth.password_reset","auth.magic_link_sent","auth.magic_link_used","auth.magic_link_expired","auth.session_created","auth.session_revoked","auth.invite_created","auth.invite_accepted","auth.invite_expired","auth.role_changed","auth.permissions_updated","user.created","user.updated","user.deleted","user.deactivated","user.reactivated","system.error","system.warning","system.info","security.suspicious_activity","security.rate_limit_exceeded","security.ip_blocked","security.account_locked"]},severity:{type:String,required:!0,enum:["low","medium","high","critical"],default:"low"},user_id:{type:String,index:!0},user_email:{type:String,index:!0},ip_address:{type:String,index:!0},user_agent:{type:String},session_id:{type:String,index:!0},resource_type:{type:String},resource_id:{type:String},action:{type:String},details:{type:n.Schema.Types.Mixed},metadata:{type:n.Schema.Types.Mixed},timestamp:{type:Date,default:Date.now,index:!0},company_id:{type:String,index:!0}},{timestamps:!0});d.index({event_type:1,timestamp:-1}),d.index({severity:1,timestamp:-1}),d.index({user_id:1,timestamp:-1}),d.index({ip_address:1,timestamp:-1}),d.index({company_id:1,timestamp:-1}),d.index({timestamp:1},{expireAfterSeconds:31536e3});let u=a().models.AuditLog||a().model("AuditLog",d);s.z.object({id:s.z.string(),event_type:s.z.enum(["auth.login","auth.logout","auth.login_failed","auth.password_reset","auth.magic_link_sent","auth.magic_link_used","auth.magic_link_expired","auth.session_created","auth.session_revoked","auth.invite_created","auth.invite_accepted","auth.invite_expired","auth.role_changed","auth.permissions_updated","user.created","user.updated","user.deleted","user.deactivated","user.reactivated","system.error","system.warning","system.info","security.suspicious_activity","security.rate_limit_exceeded","security.ip_blocked","security.account_locked"]),severity:s.z.enum(["low","medium","high","critical"]),user_id:s.z.string().optional(),user_email:s.z.string().email().optional(),ip_address:s.z.string().optional(),user_agent:s.z.string().optional(),session_id:s.z.string().optional(),resource_type:s.z.string().optional(),resource_id:s.z.string().optional(),action:s.z.string().optional(),details:s.z.record(s.z.any()).optional(),metadata:s.z.record(s.z.any()).optional(),timestamp:s.z.string().datetime(),company_id:s.z.string().optional()}),r()}catch(e){r(e)}})},7075:(e,t,i)=>{i.d(t,{k:()=>s});var r=i(1185),n=i.n(r);let a=new r.Schema({email:{type:String,required:!0},token:{type:String,required:!0,unique:!0},expiresAt:{type:Date,required:!0},used:{type:Boolean,default:!1},createdAt:{type:Date,default:Date.now}}),s=n().models.MagicLinkToken||n().model("MagicLinkToken",a)},6158:(e,t,i)=>{i.a(e,async(e,r)=>{try{i.r(t),i.d(t,{default:()=>u});var n=i(8258),a=i(9653),s=i(1053),o=i(7075),d=e([n]);async function u(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let{email:i,ssoProvider:r}=e.body;if(!i&&!r)return t.status(400).json({error:"Email or SSO provider is required"});if(await (0,s.Z)(),r){if("google"===r){let a=await c(r);return await (0,n.mI)("auth.login",i||"unknown",void 0,{provider:r,sso_url:a},e),t.status(200).json({success:!0,ssoUrl:a,message:`Redirecting to ${r} for authentication`})}return await (0,n.mI)("auth.login_failed",i||"unknown",void 0,{provider:r,reason:"unsupported_provider"},e),t.status(400).json({error:"Unsupported SSO provider"})}if(!i||!i.includes("@"))return await (0,n.mI)("auth.login_failed",i||"invalid",void 0,{reason:"invalid_email",email_provided:i},e),t.status(400).json({error:"Valid email is required"});let o=await l(i);return await (0,a.C)({to:i,subject:"Your cmdctr Magic Login Link",text:`Click this link to log in: ${o}
This link will expire in 15 minutes.`,html:`<p>Click <a href="${o}">here</a> to log in. This link will expire in 15 minutes.</p>`}),await (0,n.mI)("auth.magic_link_sent",i,void 0,{link_expires_in:"15 minutes"},e),t.status(200).json({success:!0,message:"Magic link sent to your email"})}catch(i){console.error("Login error:",i);try{await (0,n.mI)("auth.login_failed",e.body.email||"unknown",void 0,{reason:"server_error",error_message:i instanceof Error?i.message:"Unknown error"},e)}catch(e){console.error("Failed to log audit event:",e)}return t.status(500).json({error:"Internal server error"})}}async function c(e){let t={google:process.env.GOOGLE_OAUTH_URL}[e];if(!t)throw Error(`Unsupported SSO provider: ${e}`);return t}async function l(e){let t=Math.random().toString(36).substring(2)+Date.now().toString(36),i=new Date(Date.now()+9e5);return await o.k.create({email:e,token:t,expiresAt:i,used:!1,createdAt:new Date}),`${process.env.NEXT_PUBLIC_APP_URL}/auth/verify?token=${t}`}n=(d.then?(await d)():d)[0],r()}catch(e){r(e)}})},7153:(e,t)=>{var i;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return i}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(i||(i={}))},1802:(e,t,i)=>{e.exports=i(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var i=t(t.s=534);module.exports=i})();