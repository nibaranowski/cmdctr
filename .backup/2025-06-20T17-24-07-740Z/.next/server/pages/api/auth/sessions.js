"use strict";(()=>{var e={};e.id=331,e.ids=[331],e.modules={1185:e=>{e.exports=require("mongoose")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9926:e=>{e.exports=import("zod")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},1369:(e,t,r)=>{r.a(e,async(e,i)=>{try{r.r(t),r.d(t,{config:()=>c,default:()=>u,routeModule:()=>l});var s=r(1802),n=r(7153),a=r(6249),o=r(6944),d=e([o]);o=(d.then?(await d)():d)[0];let u=(0,a.l)(o,"default"),c=(0,a.l)(o,"config"),l=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/auth/sessions",pathname:"/api/auth/sessions",bundlePath:"",filename:""},userland:o});i()}catch(e){i(e)}})},8258:(e,t,r)=>{r.a(e,async(e,i)=>{try{r.d(t,{Ac:()=>c,aW:()=>l,mI:()=>u,vp:()=>d});var s=r(6413),n=r(1053),a=e([s]);async function o(e,t){try{await (0,n.Z)();let r=e.ip_address||(t?t.headers["x-forwarded-for"]?.split(",")[0]||t.headers["x-real-ip"]||t.socket?.remoteAddress||t.connection?.remoteAddress:void 0),i=e.user_agent||(t?t.headers["user-agent"]:void 0);return await s.o.create({...e,ip_address:r,user_agent:i,timestamp:new Date})}catch(e){throw console.error("Failed to log audit event:",e),e}}async function d(e){try{await (0,n.Z)();let t={};e.event_type&&(t.event_type=e.event_type),e.severity&&(t.severity=e.severity),e.user_id&&(t.user_id=e.user_id),e.user_email&&(t.user_email=e.user_email),e.ip_address&&(t.ip_address=e.ip_address),e.session_id&&(t.session_id=e.session_id),e.company_id&&(t.company_id=e.company_id),(e.start_date||e.end_date)&&(t.timestamp={},e.start_date&&(t.timestamp.$gte=e.start_date),e.end_date&&(t.timestamp.$lte=e.end_date));let r=e.limit||50,i=e.offset||0,[a,o]=await Promise.all([s.o.find(t).sort({timestamp:-1}).skip(i).limit(r+1).exec(),s.o.countDocuments(t).exec()]),d=a.length>r;return{logs:d?a.slice(0,r):a,total:o,hasMore:d}}catch(e){throw console.error("Failed to query audit logs:",e),e}}async function u(e,t,r,i,s){let n=e.includes("failed")||e.includes("expired")?"medium":"low";return o({event_type:e,severity:n,user_email:t,user_id:r,details:i},s)}async function c(e,t,r,i,s){return o({event_type:e,severity:"low",user_id:t,user_email:r,details:i},s)}async function l(e,t=30){try{await (0,n.Z)();let r=new Date;r.setDate(r.getDate()-t);let i={timestamp:{$gte:r}};e&&(i.company_id=e);let[a,o,d,u]=await Promise.all([s.o.countDocuments(i),s.o.aggregate([{$match:i},{$group:{_id:"$event_type",count:{$sum:1}}},{$sort:{count:-1}}]),s.o.aggregate([{$match:i},{$group:{_id:"$severity",count:{$sum:1}}},{$sort:{count:-1}}]),s.o.countDocuments({...i,timestamp:{$gte:new Date(Date.now()-864e5)}})]);return{total_events:a,events_by_type:o.reduce((e,t)=>(e[t._id]=t.count,e),{}),events_by_severity:d.reduce((e,t)=>(e[t._id]=t.count,e),{}),recent_activity:u}}catch(e){throw console.error("Failed to get audit stats:",e),e}}s=(a.then?(await a)():a)[0],i()}catch(e){i(e)}})},1053:(e,t,r)=>{r.d(t,{Z:()=>o});var i=r(1185),s=r.n(i);let n=process.env.MONGODB_URI;if(!n)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let a=global.mongoose;a||(a=global.mongoose={conn:null,promise:null});let o=async function(){if(a.conn)return a.conn;a.promise||(a.promise=s().connect(n,{bufferCommands:!1}).then(e=>e));try{a.conn=await a.promise}catch(e){throw a.promise=null,e}return a.conn}},6413:(e,t,r)=>{r.a(e,async(e,i)=>{try{r.d(t,{o:()=>u});var s=r(1185),n=r.n(s),a=r(9926),o=e([a]);a=(o.then?(await o)():o)[0];let d=new s.Schema({event_type:{type:String,required:!0,enum:["auth.login","auth.logout","auth.login_failed","auth.password_reset","auth.magic_link_sent","auth.magic_link_used","auth.magic_link_expired","auth.session_created","auth.session_revoked","auth.invite_created","auth.invite_accepted","auth.invite_expired","auth.role_changed","auth.permissions_updated","user.created","user.updated","user.deleted","user.deactivated","user.reactivated","system.error","system.warning","system.info","security.suspicious_activity","security.rate_limit_exceeded","security.ip_blocked","security.account_locked"]},severity:{type:String,required:!0,enum:["low","medium","high","critical"],default:"low"},user_id:{type:String,index:!0},user_email:{type:String,index:!0},ip_address:{type:String,index:!0},user_agent:{type:String},session_id:{type:String,index:!0},resource_type:{type:String},resource_id:{type:String},action:{type:String},details:{type:s.Schema.Types.Mixed},metadata:{type:s.Schema.Types.Mixed},timestamp:{type:Date,default:Date.now,index:!0},company_id:{type:String,index:!0}},{timestamps:!0});d.index({event_type:1,timestamp:-1}),d.index({severity:1,timestamp:-1}),d.index({user_id:1,timestamp:-1}),d.index({ip_address:1,timestamp:-1}),d.index({company_id:1,timestamp:-1}),d.index({timestamp:1},{expireAfterSeconds:31536e3});let u=n().models.AuditLog||n().model("AuditLog",d);a.z.object({id:a.z.string(),event_type:a.z.enum(["auth.login","auth.logout","auth.login_failed","auth.password_reset","auth.magic_link_sent","auth.magic_link_used","auth.magic_link_expired","auth.session_created","auth.session_revoked","auth.invite_created","auth.invite_accepted","auth.invite_expired","auth.role_changed","auth.permissions_updated","user.created","user.updated","user.deleted","user.deactivated","user.reactivated","system.error","system.warning","system.info","security.suspicious_activity","security.rate_limit_exceeded","security.ip_blocked","security.account_locked"]),severity:a.z.enum(["low","medium","high","critical"]),user_id:a.z.string().optional(),user_email:a.z.string().email().optional(),ip_address:a.z.string().optional(),user_agent:a.z.string().optional(),session_id:a.z.string().optional(),resource_type:a.z.string().optional(),resource_id:a.z.string().optional(),action:a.z.string().optional(),details:a.z.record(a.z.any()).optional(),metadata:a.z.record(a.z.any()).optional(),timestamp:a.z.string().datetime(),company_id:a.z.string().optional()}),i()}catch(e){i(e)}})},8359:(e,t,r)=>{r.d(t,{z:()=>a});var i=r(1185),s=r.n(i);let n=new i.Schema({userId:{type:String,required:!0},device:{type:String,required:!0},ip:{type:String,required:!0},location:{type:String,default:"Unknown"},createdAt:{type:Date,default:Date.now},lastActive:{type:Date,default:Date.now},isActive:{type:Boolean,default:!0}}),a=s().models.Session||s().model("Session",n)},6944:(e,t,r)=>{r.a(e,async(e,i)=>{try{r.r(t),r.d(t,{default:()=>d});var s=r(8258),n=r(1053),a=r(8359),o=e([s]);async function d(e,t){switch(await (0,n.Z)(),e.method){case"GET":return u(e,t);case"DELETE":return c(e,t);default:return t.status(405).json({error:"Method not allowed"})}}async function u(e,t){try{let r=e.headers["x-user-id"];if(!r)return t.status(401).json({error:"User ID required"});let i=await a.z.find({userId:r,isActive:!0}).exec();return await (0,s.mI)("auth.session_created","unknown",r,{action:"query_sessions",session_count:i.length},e),t.status(200).json({success:!0,sessions:i.map(e=>({id:e._id,device:e.device,location:e.location,ip:e.ip,lastActive:e.lastActive,isCurrent:!1}))})}catch(r){console.error("Get sessions error:",r);try{await (0,s.mI)("auth.login_failed","unknown",e.headers["x-user-id"],{action:"query_sessions",reason:"server_error",error_message:r instanceof Error?r.message:"Unknown error"},e)}catch(e){console.error("Failed to log audit event:",e)}return t.status(500).json({error:"Internal server error"})}}async function c(e,t){try{let{sessionId:r}=e.body,i=e.headers["x-user-id"];if(!r)return t.status(400).json({error:"Session ID is required"});if(!i)return t.status(401).json({error:"User ID required"});let n=await a.z.updateOne({_id:r,userId:i},{isActive:!1}).exec();if(0===n.modifiedCount)return await (0,s.mI)("auth.login_failed","unknown",i,{action:"revoke_session",session_id:r,reason:"session_not_found_or_already_revoked"},e),t.status(404).json({error:"Session not found or already revoked"});return await (0,s.mI)("auth.session_revoked","unknown",i,{session_id:r},e),t.status(200).json({success:!0,message:"Session revoked successfully"})}catch(r){console.error("Revoke session error:",r);try{await (0,s.mI)("auth.login_failed","unknown",e.headers["x-user-id"],{action:"revoke_session",session_id:e.body.sessionId,reason:"server_error",error_message:r instanceof Error?r.message:"Unknown error"},e)}catch(e){console.error("Failed to log audit event:",e)}return t.status(500).json({error:"Internal server error"})}}s=(o.then?(await o)():o)[0],i()}catch(e){i(e)}})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=1369);module.exports=r})();