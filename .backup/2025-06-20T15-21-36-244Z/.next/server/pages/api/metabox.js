"use strict";(()=>{var t={};t.id=918,t.ids=[918],t.modules={1185:t=>{t.exports=require("mongoose")},145:t=>{t.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9926:t=>{t.exports=import("zod")},6249:(t,e)=>{Object.defineProperty(e,"l",{enumerable:!0,get:function(){return function t(e,i){return i in e?e[i]:"then"in e&&"function"==typeof e.then?e.then(e=>t(e,i)):"function"==typeof e&&"default"===i?e:void 0}}})},2389:(t,e,i)=>{i.a(t,async(t,a)=>{try{i.r(e),i.d(e,{config:()=>c,default:()=>h,routeModule:()=>p});var n=i(1802),r=i(7153),s=i(6249),o=i(5277),d=t([o]);o=(d.then?(await d)():d)[0];let h=(0,s.l)(o,"default"),c=(0,s.l)(o,"config"),p=new n.PagesAPIRouteModule({definition:{kind:r.x.PAGES_API,page:"/api/metabox",pathname:"/api/metabox",bundlePath:"",filename:""},userland:o});a()}catch(t){a(t)}})},1053:(t,e,i)=>{i.d(e,{Z:()=>o});var a=i(1185),n=i.n(a);let r=process.env.MONGODB_URI;if(!r)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let s=global.mongoose;s||(s=global.mongoose={conn:null,promise:null});let o=async function(){if(s.conn)return s.conn;s.promise||(s.promise=n().connect(r,{bufferCommands:!1}).then(t=>t));try{s.conn=await s.promise}catch(t){throw s.promise=null,t}return s.conn}},1151:(t,e,i)=>{i.a(t,async(t,a)=>{try{i.d(e,{HR:()=>h,jU:()=>d});var n=i(9926),r=t([n]);let s=(n=(r.then?(await r)():r)[0]).z.object({id:n.z.string().min(1),name:n.z.string().min(1),order:n.z.number().int().nonnegative(),description:n.z.string().optional(),agent_id:n.z.string().optional(),metabox_id:n.z.string().min(1),created_at:n.z.string().datetime(),updated_at:n.z.string().datetime()}),o=n.z.object({id:n.z.string().min(1),name:n.z.string().min(1),description:n.z.string(),phases:n.z.array(s),created_at:n.z.string().datetime(),updated_at:n.z.string().datetime(),version:n.z.number().int().positive()}),d=n.z.object({id:n.z.string().min(1),name:n.z.string().min(1),description:n.z.string().optional(),company_id:n.z.string().min(1),owner_id:n.z.string().optional(),shared_with:n.z.array(n.z.string()),phases:n.z.array(s),templates:n.z.array(o),version:n.z.number().int().positive(),created_at:n.z.string().datetime(),updated_at:n.z.string().datetime(),metadata:n.z.record(n.z.unknown()).optional()});class h{constructor(t){this.id=t.id||`metabox_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,this.name=t.name,this.description=t.description,this.company_id=t.company_id,this.owner_id=t.owner_id,this.shared_with=t.shared_with||[],this.phases=(t.phases||[]).map(t=>new p(t)),this.templates=(t.templates||[]).map(t=>new c(t)),this.version=t.version||1,this.created_at=t.created_at||new Date().toISOString(),this.updated_at=t.updated_at||new Date().toISOString(),this.metadata=t.metadata}update(t){void 0!==t.name&&(this.name=t.name),void 0!==t.description&&(this.description=t.description),void 0!==t.shared_with&&(this.shared_with=t.shared_with),void 0!==t.metadata&&(this.metadata=t.metadata),this.version++,this.updated_at=new Date().toISOString()}addPhase(t){let e=new p({...t,metabox_id:this.id});this.phases.push(e),this.phases.sort((t,e)=>t.order-e.order),this.version++,this.updated_at=new Date().toISOString()}removePhase(t){let e=this.phases.length;return this.phases=this.phases.filter(e=>e.id!==t),this.phases.length!==e&&(this.version++,this.updated_at=new Date().toISOString(),!0)}createTemplate(t,e){let i=new c({name:t,description:e,phases:this.phases.map(t=>({id:t.id,name:t.name,order:t.order,description:t.description,agent_id:t.agent_id,metabox_id:t.metabox_id,created_at:t.created_at,updated_at:t.updated_at}))});return this.templates.push(i),this.version++,this.updated_at=new Date().toISOString(),i}applyTemplate(t){this.phases=t.phases.map(t=>new p({...t,id:`phase_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,metabox_id:this.id,created_at:new Date().toISOString(),updated_at:new Date().toISOString()})),this.version++,this.updated_at=new Date().toISOString()}canAccess(t){return this.owner_id===t||this.shared_with.includes(t)}canEdit(t){return this.owner_id===t}detectConflict(t){return t.version<this.version?{hasConflict:!0,message:`Version conflict: local version ${this.version}, incoming version ${t.version}`}:{hasConflict:!1}}}class c{constructor(t){this.id=t.id||`template_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,this.name=t.name,this.description=t.description,this.phases=(t.phases||[]).map(t=>new p(t)),this.created_at=t.created_at||new Date().toISOString(),this.updated_at=t.updated_at||new Date().toISOString(),this.version=t.version||1}update(t){void 0!==t.name&&(this.name=t.name),void 0!==t.description&&(this.description=t.description),void 0!==t.phases&&(this.phases=t.phases.map(t=>new p(t))),this.version++,this.updated_at=new Date().toISOString()}}class p{constructor(t){this.id=t.id||`phase_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,this.name=t.name,this.order=t.order,this.description=t.description,this.agent_id=t.agent_id,this.metabox_id=t.metabox_id,this.created_at=t.created_at||new Date().toISOString(),this.updated_at=t.updated_at||new Date().toISOString()}update(t){void 0!==t.name&&(this.name=t.name),void 0!==t.order&&(this.order=t.order),void 0!==t.description&&(this.description=t.description),void 0!==t.agent_id&&(this.agent_id=t.agent_id),this.updated_at=new Date().toISOString()}}a()}catch(t){a(t)}})},5277:(t,e,i)=>{i.a(t,async(t,a)=>{try{i.r(e),i.d(e,{default:()=>h});var n=i(1185),r=i.n(n),s=i(1053),o=i(1151),d=t([o]);async function h(t,e){return"GET"===t.method?c(t,e):"POST"===t.method?p(t,e):void(e.setHeader("Allow",["GET","POST"]),e.status(405).json({error:"Method not allowed"}))}async function c(t,e){try{let{company_id:i,user_id:a}=t.query;if(!i||"string"!=typeof i)return e.status(400).json({error:"company_id is required"});await (0,s.Z)();let n=r().model("MetaBox",new(r()).Schema({})).collection,d={company_id:i};a&&"string"==typeof a&&(d.$or=[{owner_id:a},{shared_with:a}]);let h=(await n.find(d).toArray()).map(t=>new o.HR(t));e.status(200).json({success:!0,data:h,count:h.length})}catch(t){console.error("Error fetching meta boxes:",t),e.status(500).json({error:"Internal server error"})}}async function p(t,e){try{let{company_id:i,user_id:a}=t.body;if(!i||!a)return e.status(400).json({error:"company_id and user_id are required"});let n=o.jU.safeParse(t.body);if(!n.success)return e.status(400).json({error:"Invalid meta box data",details:n.error.errors});await (0,s.Z)();let d=r().model("MetaBox",new(r()).Schema({})).collection,h=new o.HR({...t.body,owner_id:a});(await d.insertOne(h)).acknowledged?e.status(201).json({success:!0,data:h,message:"Meta box created successfully"}):e.status(500).json({error:"Failed to create meta box"})}catch(t){console.error("Error creating meta box:",t),e.status(500).json({error:"Internal server error"})}}o=(d.then?(await d)():d)[0],a()}catch(t){a(t)}})},7153:(t,e)=>{var i;Object.defineProperty(e,"x",{enumerable:!0,get:function(){return i}}),function(t){t.PAGES="PAGES",t.PAGES_API="PAGES_API",t.APP_PAGE="APP_PAGE",t.APP_ROUTE="APP_ROUTE"}(i||(i={}))},1802:(t,e,i)=>{t.exports=i(145)}};var e=require("../../webpack-api-runtime.js");e.C(t);var i=e(e.s=2389);module.exports=i})();