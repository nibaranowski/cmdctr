"use strict";(()=>{var e={};e.id=640,e.ids=[640],e.modules={1185:e=>{e.exports=require("mongoose")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9926:e=>{e.exports=import("zod")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,i){return i in t?t[i]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,i)):"function"==typeof t&&"default"===i?t:void 0}}})},1837:(e,t,i)=>{i.a(e,async(e,a)=>{try{i.r(t),i.d(t,{config:()=>c,default:()=>u,routeModule:()=>l});var r=i(1802),n=i(7153),s=i(6249),o=i(8857),d=e([o]);o=(d.then?(await d)():d)[0];let u=(0,s.l)(o,"default"),c=(0,s.l)(o,"config"),l=new r.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/auth/verify",pathname:"/api/auth/verify",bundlePath:"",filename:""},userland:o});a()}catch(e){a(e)}})},8258:(e,t,i)=>{i.a(e,async(e,a)=>{try{i.d(t,{Ac:()=>c,aW:()=>l,mI:()=>u,vp:()=>d});var r=i(6413),n=i(1053),s=e([r]);async function o(e,t){try{await (0,n.Z)();let i=e.ip_address||(t?t.headers["x-forwarded-for"]?.split(",")[0]||t.headers["x-real-ip"]||t.socket?.remoteAddress||t.connection?.remoteAddress:void 0),a=e.user_agent||(t?t.headers["user-agent"]:void 0);return await r.o.create({...e,ip_address:i,user_agent:a,timestamp:new Date})}catch(e){throw console.error("Failed to log audit event:",e),e}}async function d(e){try{await (0,n.Z)();let t={};e.event_type&&(t.event_type=e.event_type),e.severity&&(t.severity=e.severity),e.user_id&&(t.user_id=e.user_id),e.user_email&&(t.user_email=e.user_email),e.ip_address&&(t.ip_address=e.ip_address),e.session_id&&(t.session_id=e.session_id),e.company_id&&(t.company_id=e.company_id),(e.start_date||e.end_date)&&(t.timestamp={},e.start_date&&(t.timestamp.$gte=e.start_date),e.end_date&&(t.timestamp.$lte=e.end_date));let i=e.limit||50,a=e.offset||0,[s,o]=await Promise.all([r.o.find(t).sort({timestamp:-1}).skip(a).limit(i+1).exec(),r.o.countDocuments(t).exec()]),d=s.length>i;return{logs:d?s.slice(0,i):s,total:o,hasMore:d}}catch(e){throw console.error("Failed to query audit logs:",e),e}}async function u(e,t,i,a,r){let n=e.includes("failed")||e.includes("expired")?"medium":"low";return o({event_type:e,severity:n,user_email:t,user_id:i,details:a},r)}async function c(e,t,i,a,r){return o({event_type:e,severity:"low",user_id:t,user_email:i,details:a},r)}async function l(e,t=30){try{await (0,n.Z)();let i=new Date;i.setDate(i.getDate()-t);let a={timestamp:{$gte:i}};e&&(a.company_id=e);let[s,o,d,u]=await Promise.all([r.o.countDocuments(a),r.o.aggregate([{$match:a},{$group:{_id:"$event_type",count:{$sum:1}}},{$sort:{count:-1}}]),r.o.aggregate([{$match:a},{$group:{_id:"$severity",count:{$sum:1}}},{$sort:{count:-1}}]),r.o.countDocuments({...a,timestamp:{$gte:new Date(Date.now()-864e5)}})]);return{total_events:s,events_by_type:o.reduce((e,t)=>(e[t._id]=t.count,e),{}),events_by_severity:d.reduce((e,t)=>(e[t._id]=t.count,e),{}),recent_activity:u}}catch(e){throw console.error("Failed to get audit stats:",e),e}}r=(s.then?(await s)():s)[0],a()}catch(e){a(e)}})},1053:(e,t,i)=>{i.d(t,{Z:()=>o});var a=i(1185),r=i.n(a);let n=process.env.MONGODB_URI;if(!n)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let s=global.mongoose;s||(s=global.mongoose={conn:null,promise:null});let o=async function(){if(s.conn)return s.conn;s.promise||(s.promise=r().connect(n,{bufferCommands:!1}).then(e=>e));try{s.conn=await s.promise}catch(e){throw s.promise=null,e}return s.conn}},6413:(e,t,i)=>{i.a(e,async(e,a)=>{try{i.d(t,{o:()=>u});var r=i(1185),n=i.n(r),s=i(9926),o=e([s]);s=(o.then?(await o)():o)[0];let d=new r.Schema({event_type:{type:String,required:!0,enum:["auth.login","auth.logout","auth.login_failed","auth.password_reset","auth.magic_link_sent","auth.magic_link_used","auth.magic_link_expired","auth.session_created","auth.session_revoked","auth.invite_created","auth.invite_accepted","auth.invite_expired","auth.role_changed","auth.permissions_updated","user.created","user.updated","user.deleted","user.deactivated","user.reactivated","system.error","system.warning","system.info","security.suspicious_activity","security.rate_limit_exceeded","security.ip_blocked","security.account_locked"]},severity:{type:String,required:!0,enum:["low","medium","high","critical"],default:"low"},user_id:{type:String,index:!0},user_email:{type:String,index:!0},ip_address:{type:String,index:!0},user_agent:{type:String},session_id:{type:String,index:!0},resource_type:{type:String},resource_id:{type:String},action:{type:String},details:{type:r.Schema.Types.Mixed},metadata:{type:r.Schema.Types.Mixed},timestamp:{type:Date,default:Date.now,index:!0},company_id:{type:String,index:!0}},{timestamps:!0});d.index({event_type:1,timestamp:-1}),d.index({severity:1,timestamp:-1}),d.index({user_id:1,timestamp:-1}),d.index({ip_address:1,timestamp:-1}),d.index({company_id:1,timestamp:-1}),d.index({timestamp:1},{expireAfterSeconds:31536e3});let u=n().models.AuditLog||n().model("AuditLog",d);s.z.object({id:s.z.string(),event_type:s.z.enum(["auth.login","auth.logout","auth.login_failed","auth.password_reset","auth.magic_link_sent","auth.magic_link_used","auth.magic_link_expired","auth.session_created","auth.session_revoked","auth.invite_created","auth.invite_accepted","auth.invite_expired","auth.role_changed","auth.permissions_updated","user.created","user.updated","user.deleted","user.deactivated","user.reactivated","system.error","system.warning","system.info","security.suspicious_activity","security.rate_limit_exceeded","security.ip_blocked","security.account_locked"]),severity:s.z.enum(["low","medium","high","critical"]),user_id:s.z.string().optional(),user_email:s.z.string().email().optional(),ip_address:s.z.string().optional(),user_agent:s.z.string().optional(),session_id:s.z.string().optional(),resource_type:s.z.string().optional(),resource_id:s.z.string().optional(),action:s.z.string().optional(),details:s.z.record(s.z.any()).optional(),metadata:s.z.record(s.z.any()).optional(),timestamp:s.z.string().datetime(),company_id:s.z.string().optional()}),a()}catch(e){a(e)}})},7075:(e,t,i)=>{i.d(t,{k:()=>s});var a=i(1185),r=i.n(a);let n=new a.Schema({email:{type:String,required:!0},token:{type:String,required:!0,unique:!0},expiresAt:{type:Date,required:!0},used:{type:Boolean,default:!1},createdAt:{type:Date,default:Date.now}}),s=r().models.MagicLinkToken||r().model("MagicLinkToken",n)},8359:(e,t,i)=>{i.d(t,{z:()=>s});var a=i(1185),r=i.n(a);let n=new a.Schema({userId:{type:String,required:!0},device:{type:String,required:!0},ip:{type:String,required:!0},location:{type:String,default:"Unknown"},createdAt:{type:Date,default:Date.now},lastActive:{type:Date,default:Date.now},isActive:{type:Boolean,default:!0}}),s=r().models.Session||r().model("Session",n)},971:(e,t,i)=>{i.a(e,async(e,a)=>{try{i.d(t,{n:()=>u});var r=i(1185),n=i.n(r),s=i(9926),o=e([s]);s=(o.then?(await o)():o)[0];let d=new r.Schema({name:{type:String,required:!0},email:{type:String,required:!0,unique:!0},avatar_url:{type:String},roles:{type:[String],enum:["founder","ops_manager","team_member","investor","partner","external_expert"],default:["team_member"]},last_login:{type:Date,default:Date.now},company_id:{type:String},isActive:{type:Boolean,default:!0},permissions:{type:[String],default:["read"]}},{timestamps:!0}),u=n().models.User||n().model("User",d);s.z.object({id:s.z.string(),name:s.z.string(),email:s.z.string().email(),avatar_url:s.z.string().url(),roles:s.z.array(s.z.enum(["founder","ops_manager","team_member","investor","partner","external_expert"])),last_login:s.z.string().datetime(),company_id:s.z.string()}),a()}catch(e){a(e)}})},8857:(e,t,i)=>{i.a(e,async(e,a)=>{try{i.r(t),i.d(t,{default:()=>c});var r=i(8258),n=i(1053),s=i(7075),o=i(8359),d=i(971),u=e([r,d]);async function c(e,t){if("GET"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let{token:i}=e.query;if(!i||"string"!=typeof i)return t.status(400).json({error:"Valid token is required"});await (0,n.Z)();let a=await l(i);if(!a)return await (0,r.mI)("auth.magic_link_expired","unknown",void 0,{token_provided:`${i.substring(0,10)}...`,reason:"invalid_or_expired"},e),t.status(400).json({error:"Invalid or expired token"});let s=await d.n.findOne({email:a.email}).exec(),o=!1;s||(s=await d.n.create({email:a.email,name:a.email.split("@")[0],role:"member",permissions:["read"],isActive:!0,createdAt:new Date,updatedAt:new Date}),o=!0,await (0,r.Ac)("user.created",s._id.toString(),s.email,{role:s.role,permissions:s.permissions},e));let u=await m(s._id,e);return await p(i),await (0,r.mI)("auth.magic_link_used",s.email,s._id.toString(),{is_new_user:o,session_id:u.id},e),await (0,r.mI)("auth.session_created",s.email,s._id.toString(),{session_id:u.id,device:u.device,ip:u.ip},e),t.setHeader("Set-Cookie",`session=${u.id}; HttpOnly; Secure; SameSite=Strict; Max-Age=604800`),t.status(200).json({success:!0,user:{id:s._id,email:s.email,name:s.name,role:s.role,permissions:s.permissions},session:u.id})}catch(i){console.error("Token verification error:",i);try{await (0,r.mI)("auth.login_failed","unknown",void 0,{reason:"verification_error",error_message:i instanceof Error?i.message:"Unknown error",token_provided:e.query.token?`${e.query.token.substring(0,10)}...`:"none"},e)}catch(e){console.error("Failed to log audit event:",e)}return t.status(500).json({error:"Internal server error"})}}async function l(e){let t=await s.k.findOne({token:e}).exec();return!t||t.used||t.expiresAt<new Date?null:{email:t.email}}async function m(e,t){let i=await o.z.create({userId:e,device:t.headers["user-agent"]||"Unknown",ip:t.headers["x-forwarded-for"]||t.socket.remoteAddress||"Unknown",location:"Unknown",createdAt:new Date,lastActive:new Date,isActive:!0});return{id:i._id,userId:i.userId,device:i.device,ip:i.ip,location:i.location,createdAt:i.createdAt,lastActive:i.lastActive,isActive:i.isActive}}async function p(e){await s.k.updateOne({token:e},{used:!0}).exec()}[r,d]=u.then?(await u)():u,a()}catch(e){a(e)}})},7153:(e,t)=>{var i;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return i}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(i||(i={}))},1802:(e,t,i)=>{e.exports=i(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var i=t(t.s=1837);module.exports=i})();